#!/usr/bin/env sh

NODE=""
case "${1}" in
  -n=*)
    NODE=${1#-n=}
    shift
    ;;
  --node=*)
    NODE=${1#--node=}
    shift
    ;;
  -n|--node)
    NODE=${2}
    shift
    shift
    ;;
esac
if [ -z "${NODE}" ]; then
    NODESELECTOR=""
else
    NODESELECTOR='
    "nodeSelector": {
      "kubernetes.io/hostname": "'"${NODE}"'"
    },'
fi

kubectl run debug-pod \
    --namespace kube-system \
    --image debian \
    --stdin --tty --rm \
    --overrides='
{
  "apiVersion": "v1",
  "kind": "Pod",
  "metadata": {
    "name": "debug-pod",
    "namespace": "kube-system"
  },
  "spec": {
    "containers": [{
      "image": "debian",
      "name": "debug-pod",
      "stdin": true,
      "stdinOnce": true,
      "tty": true,
      "securityContext": {
        "privileged": true,
        "runAsUser": 0
      },
      "volumeMounts": [{
        "mountPath": "/host",
        "name": "host"
      }]
    }],
    '"${NODESELECTOR}"'"restartPolicy": "Never",
    "hostIPC": true,
    "hostNetwork": true,
    "hostPID": true,
    "volumes": [{
      "name": "host",
      "hostPath": {
        "path": "/",
        "type": "Directory"
      }
    }]
  }
}' \
    $@
