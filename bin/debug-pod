#!/usr/bin/env sh

NODE=""
FOREGROUND="--stdin --tty --rm"
BACKGROUND=""

while :; do
    case "${1}" in
      -n=*)
        NODE=${1#-n=}
        ;;
      --node=*)
        NODE=${1#--node=}
        ;;
      -n|--node)
        NODE=${2}
        shift
        ;;
      -b|--background)
        FOREGROUND=""
        BACKGROUND='
    "args": ["sh", "-c", "sleep infinity"],'
        ;;
     *)
       break
       ;;
    esac
    shift
done

if [ -z "${NODE}" ]; then
    NODESELECTOR=""
else
    NODESELECTOR='
    "nodeSelector": {
      "kubernetes.io/hostname": "'"${NODE}"'"
    },'
fi

kubectl run debug-pod \
    --namespace kube-system \
    --image debian \
    ${FOREGROUND} \
    --overrides='
{
  "apiVersion": "v1",
  "kind": "Pod",
  "metadata": {
    "name": "debug-pod",
    "namespace": "kube-system"
  },
  "spec": {
    "containers": [{
      "image": "debian",
      '"${BACKGROUND}"'
      "name": "debug-pod",
      "stdin": true,
      "stdinOnce": true,
      "tty": true,
      "securityContext": {
        "privileged": true,
        "runAsUser": 0
      },
      "volumeMounts": [{
        "mountPath": "/host",
        "name": "host"
      }]
    }],
    '"${NODESELECTOR}"'
    "restartPolicy": "Never",
    "hostIPC": true,
    "hostNetwork": true,
    "hostPID": true,
    "volumes": [{
      "name": "host",
      "hostPath": {
        "path": "/",
        "type": "Directory"
      }
    }]
  }
}'
